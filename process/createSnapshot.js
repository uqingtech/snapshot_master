"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const puppeteer=require("puppeteer"),config_1=require("../config"),fs=require("fs-extra"),sharp=require("sharp"),imgUrl=`${config_1.default.STATIC.dir}/${config_1.default.DIR.cacheDir}`,sleep=async r=>new Promise((e,t)=>{setTimeout(()=>{e()},r)}),autoScroll=async e=>e.evaluate(()=>new Promise((s,e)=>{let t=Array.from(document.querySelectorAll("img")),i=[];if(t.forEach((e,t)=>{e.getAttribute("data-src")&&i.push(e)}),!i.length)return n(),!1;let o=0;function n(){let e=0;const t=window.screen.height,r=document.body.scrollHeight,a=r-window.screen.height,i=setInterval(()=>{window.scrollBy(0,t),e+=t,e>=a&&(window.scrollTo(0,0),s(r),clearInterval(i))},500)}i.forEach((e,t)=>{var r=e.getAttribute("data-src");let a=setTimeout(()=>{o++},3e4);e.onload=function(){clearTimeout(a),o++,o===i.length&&n()},e.onerror=function(){clearTimeout(a),o++},e.src=r})})),setPageWaiter=async e=>{e.on("console",t=>{for(let e=0;e<t.args().length;++e);});let i=0,s=0,o=0;e.on("request",()=>{i++}),e.on("requestfinished",()=>{s++}),e.on("requestfailed",()=>{o++});let n=await autoScroll(e);return await sleep(3e3),new Promise(async(e,t)=>{let r=0,a=setInterval(()=>{r++,0!==i&&i===s+o&&(e(n),clearInterval(a)),20<r&&(e(n),clearInterval(a))},3e3)})},createLongImage=async(r,a,i,s)=>new Promise((e,t)=>{sharp({create:{width:r,height:a,channels:4,background:{r:255,g:255,b:255,alpha:1}}}).composite(i).toFile(s).then(()=>{e()}).catch(e=>{})});process.on("message",async r=>{setTimeout(()=>{process.send({flag:!1,err:"err"}),process.exit(0)},3e5);var a=812;const e=await puppeteer.launch();try{const c=await e.newPage();await c.setViewport({width:r.width||375,height:a,deviceScaleFactor:2,isMobile:r.isMobile}),await c.setUserAgent(r.userAgent),await c.goto(r.url,{timeout:12e4,waitUntil:"networkidle0"});var i=await setPageWaiter(c);let t=[];var s=`${imgUrl}/${r.fileName}.png`,o=`${imgUrl}/${r.fileName}`;if(i<a)await c.screenshot({path:s,type:"png",clip:{x:0,y:0,width:r.width||375,height:i}});else{await fs.ensureDir(o);var n=Math.floor(i/a),l=i%a;for(let e=0;e<n;e++)await c.screenshot({path:`${o}/${r.fileName}${e}.png`,type:"png",clip:{x:0,y:e*a,width:r.width||375,height:a}}),t.push({input:`${o}/${r.fileName}${e}.png`,top:2*e*a,left:0});await c.screenshot({path:`${o}/${r.fileName}${n}.png`,type:"png",clip:{x:0,y:n*a,width:r.width||375,height:l}}),t.push({input:`${o}/${r.fileName}${n}.png`,top:2*n*a,left:0}),await createLongImage(2*r.width||375,2*i,t,s)}process.send({flag:!0}),process.exit(0)}catch(e){process.send({flag:!1,err:e}),process.exit(0)}await e.close()});