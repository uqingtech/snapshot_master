"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const puppeteer=require("puppeteer"),config_1=require("../config"),imgUrl=`${config_1.default.STATIC.dir}/${config_1.default.DIR.cacheDir}`,sleep=async r=>new Promise((e,t)=>{setTimeout(()=>{e()},r)}),autoScroll=async e=>e.evaluate(()=>new Promise((o,e)=>{let t=Array.from(document.querySelectorAll("img")),s=[];if(t.forEach((e,t)=>{e.getAttribute("data-src")&&s.push(e)}),!s.length)return n(),!1;let i=0;function n(){let e=0;const t=window.screen.height;const r=document.body.scrollHeight-window.screen.height,a=setInterval(()=>{window.scrollBy(0,t),e+=t,e>=r&&(o(),clearInterval(a))},500)}s.forEach((e,t)=>{var r=e.getAttribute("data-src");let a=setTimeout(()=>{i++},3e4);e.onload=function(){clearTimeout(a),i++,i===s.length&&n()},e.onerror=function(){clearTimeout(a),i++},e.src=r})})),setPageWaiter=async e=>{e.on("console",t=>{for(let e=0;e<t.args().length;++e);});let o=0,s=0,i=0;return e.on("request",()=>{o++}),e.on("requestfinished",()=>{s++}),e.on("requestfailed",()=>{i++}),await autoScroll(e),await sleep(3e3),new Promise(async(e,t)=>{let r=0,a=setInterval(()=>{r++,0!==o&&o===s+i&&(e(),clearInterval(a)),20<r&&(e(),clearInterval(a))},3e3)})};process.on("message",async e=>{setTimeout(()=>{process.send({flag:!1,err:"err"}),process.exit(0)},3e5);const t=await puppeteer.launch();try{const r=await t.newPage();await r.setViewport({width:e.width||375,height:812,deviceScaleFactor:2,isMobile:e.isMobile}),await r.setUserAgent(e.userAgent),await r.goto(e.url,{timeout:12e4,waitUntil:"networkidle0"}),await setPageWaiter(r),await r.screenshot({path:`${imgUrl}/${e.fileName}`,type:"png",fullPage:!0}),process.send({flag:!0}),process.exit(0)}catch(e){process.send({flag:!1,err:e}),process.exit(0)}await t.close()});