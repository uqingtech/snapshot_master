"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Router=require("koa-router"),child=require("child_process"),path=require("path"),uuidv1=require("uuid/v1"),snapQueue_1=require("../lib/snapQueue"),config_1=require("../config"),snapshot_service_1=require("../service/snapshot.service"),queryString=require("querystring"),startSnapshot_1=require("../methods/startSnapshot"),createSnapshot=path.join(__dirname,"../process/createSnapshot"),snapQueue=snapQueue_1.default.getInstance(),router=new Router;function default_1(l){const g=new snapshot_service_1.default(l);router.get("/",async(e,s)=>{await e.render("snapshot",{title:"截屏工具 V1.0"})}),router.post("/getSnapshot",async(e,s)=>{let r=e.request.body.url;var t=parseInt(e.request.body.width,10),a=e.request.body.isMobile,o=e.request.body.userAgent;let u=e.request.body.userData||"";if(!r)return e.response.body=l.responseMessage.successMessage({msg:"url不能为空",key:null}),!1;let i=child.fork(createSnapshot,[],{}),n=uuidv1();const p=`image${+new Date+Math.floor(1e5*Math.random())}`,d=`${config_1.default.DOMAIN}${config_1.default.STATIC.prefix}/${config_1.default.DIR.cacheDir}/${p}.png`;i.on("message",async e=>{if(e.flag)try{await g.createSnapshot({id:n,snap_url:r,file_name:p,preview_url:d,img_flag:0,user_data:u})}catch(e){}else try{await g.createSnapshot({id:n,snap_url:r,file_name:p,preview_url:d,img_flag:1,user_data:u})}catch(e){}}),i.send({url:r,fileName:p,width:t,isMobile:!!a,userAgent:o||"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1"}),e.response.body=l.responseMessage.successMessage({key:n})}),router.post("/getSnapshotImg",async(s,e)=>{var r=s.request.body.key;try{var t=await g.getSnapshot(r);(t=JSON.parse(JSON.stringify(t)))?1===t.img_flag?s.response.body=l.responseMessage.errorMessage({errCode:2,msg:"截图生成失败，请确保网址正确！"}):2===t.img_flag?s.response.body=l.responseMessage.errorMessage({errCode:3,msg:"截图已被过期清理！"}):s.response.body=l.responseMessage.successMessage({url:t.preview_url}):s.response.body=l.responseMessage.errorMessage({msg:"未找到图片"})}catch(e){s.response.body=l.responseMessage.errorMessage({msg:"未找到图片"})}}),router.post("/getSnapshotV2",async(s,e)=>{var r=s.request.body.url,t=parseInt(s.request.body.width,10),a=s.request.body.isMobile,o=s.request.body.userAgent,u=s.request.body.userData||"",i=s.request.body.openId||"",n=uuidv1(),p=`image${+new Date}${Math.floor(1e5*Math.random())}`,d=`${config_1.default.DOMAIN}${config_1.default.STATIC.prefix}/${config_1.default.DIR.cacheDir}/${p}.png`,o=queryString.stringify({id:n,url:r,width:t,isMobile:a,userAgent:o,userData:u,fileName:p,preview_url:d,open_id:i});try{await l.redis.lpush("list",[o]),await g.createSnapshot({open_id:i,id:n,snap_url:r,file_name:p,preview_url:d,img_flag:3,user_data:u}),(0,startSnapshot_1.startSnapshot)(g)}catch(e){s.response.body=l.responseMessage.errorMessage({msg:"error"})}s.response.body=l.responseMessage.successMessage({key:n})}),l.use(router.routes(),router.allowedMethods())}router.prefix("/snapshot"),exports.default=default_1;